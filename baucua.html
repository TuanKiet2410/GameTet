<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫ßu Cua V4 - Ch·∫ø ƒê·ªô Nh√† C√°i</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #b71c1c; color: #333; text-align: center; margin: 0; padding: 10px; user-select: none; }
        .screen { display: none; max-width: 600px; margin: 0 auto; background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .active { display: block; }
        
        input, button, select { width: 100%; padding: 12px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box;}
        button { font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #ffeb3b; color: #d32f2f; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-disabled { background: #ccc !important; cursor: not-allowed; color: #666 !important; }

        .dice-box { display: flex; justify-content: center; gap: 10px; margin: 15px 0; background: #eee; padding: 10px; border-radius: 10px; }
        .dice { width: 50px; height: 50px; font-size: 2rem; display: flex; align-items: center; justify-content: center; background: white; border-radius: 5px; border: 1px solid #ddd; }
        
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .bet-item { border: 1px solid #ddd; padding: 5px; border-radius: 5px; cursor: pointer; position: relative; background: #fafafa; transition: transform 0.1s; }
        .bet-item:active { transform: scale(0.95); }
        
        .my-bet-badge { position: absolute; top: -5px; right: -5px; background: #d32f2f; color: white; padding: 2px 6px; font-size: 0.7rem; border-radius: 10px; font-weight: bold; }
        .total-bet { font-weight: bold; color: #d32f2f; font-size: 0.9rem; }
        .detail-list { font-size: 0.7rem; color: #555; text-align: left; margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 2px; height: 40px; overflow-y: auto; }
        .detail-item { display: flex; justify-content: space-between; }

        .shaking { animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }

        /* Winner Popup */
        .winner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .winner-box { background: linear-gradient(135deg, #FFD700, #FF8C00); padding: 30px; border-radius: 20px; box-shadow: 0 0 20px #FFD700; text-align: center; border: 5px solid #fff; transform: scale(0.8); animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .winner-name { font-size: 2.5rem; font-weight: bold; color: #d32f2f; text-shadow: 2px 2px 0 #fff; margin: 10px 0; }
        @keyframes popUp { to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* UI Elements */
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: #eee; padding: 8px; border-radius: 5px; margin-bottom: 10px; }
        .balance { color: #2e7d32; font-weight: bold; font-size: 1.1rem; }
        .player-list { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; justify-content: center; }
        .player-tag { font-size: 0.8rem; padding: 3px 8px; border-radius: 15px; background: #e0e0e0; border: 1px solid #ccc; display: flex; align-items: center; gap: 5px;}
        .player-tag.ready { background: #C8E6C9; border-color: #4CAF50; color: #2e7d32; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #999; }
        .ready .status-dot { background: #4CAF50; }
        .admin-only { display: none !important; }
        .admin-controls { border-top: 2px solid #ddd; margin-top: 15px; padding-top: 10px; }
        
        .bet-control-panel { display: flex; align-items: center; justify-content: center; gap: 10px; background: #FFF3E0; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #FFCC80; }
        .bet-input-wrapper { display: flex; align-items: center; width: 60%; }
        .bet-input-wrapper input { text-align: center; font-weight: bold; font-size: 1.2rem; color: #d32f2f; margin: 0; }
        
        /* Host Badge */
        .host-badge { background: #d32f2f; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.7rem; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active">
        <h1 style="color: #d32f2f;">üßß B·∫¶U CUA V4 (NH√Ä C√ÅI) üßß</h1>
        <input type="text" id="username" placeholder="T√™n c·ªßa b·∫°n (VD: T√≠)">
        <input type="text" id="roomName" placeholder="T√™n ph√≤ng (VD: 6789)">
        <label style="display:block; text-align:left; font-size: 0.9rem; color: #666;">V·ªën mang theo:</label>
        <input type="number" id="startBalance" value="1000" placeholder="S·ªë ti·ªÅn v·ªën">
        <button class="btn-primary" onclick="joinGame()">V√ÄO PH√íNG</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="top-bar">
            <div>
                <span id="displayName" style="font-weight: bold;">User</span>
                <span id="roleLabel"></span>
            </div>
            <span class="balance"><span id="displayBalance">0</span> $</span>
        </div>

        <div id="playerList" class="player-list"></div>
        <div id="log">Ch√†o m·ª´ng b·∫°n!</div>

        <div class="dice-box">
            <div class="dice" id="d1">‚ùì</div>
            <div class="dice" id="d2">‚ùì</div>
            <div class="dice" id="d3">‚ùì</div>
        </div>

        <div class="bet-control-panel">
            <label style="font-weight:bold; white-space: nowrap;">C∆∞·ª£c:</label>
            <div class="bet-input-wrapper">
                <input type="number" id="betInput" value="10" min="1" max="100" onchange="validateBetInput(this)">
            </div>
            <span style="font-weight:bold; color:#666">$</span>
        </div>

        <div style="display: flex; gap: 5px;">
            <button id="readyBtn" class="btn-success" onclick="toggleReady()">CH·ªêT ƒê∆†N (Xong)</button>
            <button id="shakeBtn" class="btn-primary btn-disabled admin-only" onclick="requestShake()" disabled>X√ìC ƒêƒ®A (Nh√† c√°i)</button>
        </div>

        <div class="board" id="board"></div>

        <div id="adminPanel" class="admin-controls admin-only">
            <div class="admin-title">üëë B·∫£ng ƒëi·ªÅu khi·ªÉn NH√Ä C√ÅI üëë</div>
            <div style="display: flex; gap: 5px;">
                <button onclick="triggerRefund()" class="btn-warning" style="font-size: 0.8rem;">‚ö† H·ª¶Y & HO√ÄN TI·ªÄN</button>
                <button onclick="clearTable()" class="btn-danger" style="font-size: 0.8rem;">üóë V√ÅN M·ªöI</button>
            </div>
        </div>
    </div>

    <div id="winnerOverlay" class="winner-overlay" onclick="closeWinnerPopup()">
        <div class="winner-box">
            <div style="font-size: 1.2rem; color: #fff;">üëë TH·∫¶N B√ÄI V√ÅN N√ÄY üëë</div>
            <div class="winner-name" id="winName">Name</div>
            <div style="font-size: 2rem; color: #fff; font-weight:bold" id="winAmount">+0$</div>
            <div style="margin-top:10px; color:#fff; font-size:0.8rem">Ch·∫°m ƒë·ªÉ ƒë√≥ng</div>
        </div>
    </div>

    <audio id="soundWin" src="https://www.soundjay.com/misc/sounds/coins-in-hand-2.mp3" preload="auto"></audio>
    <audio id="soundLose" src="https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3" preload="auto"></audio>

    <script>
        // --- C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDezhyeDURAA_WfX8xxhGJ7KcNTVM8cwO4",
            authDomain: "tuankiet-gametet.firebaseapp.com",
            projectId: "tuankiet-gametet",
            storageBucket: "tuankiet-gametet.firebasestorage.app",
            messagingSenderId: "406766414133",
            appId: "1:406766414133:web:e4a99221da90dcc657847c",
            measurementId: "G-KJT59Z8FCK"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        const mascots = [
            {id: 'nai', i:'ü¶å', n:'Nai'}, {id: 'bau', i:'ü•í', n:'B·∫ßu'}, 
            {id: 'ga', i:'üêî', n:'G√†'}, {id: 'ca', i:'üêü', n:'C√°'}, 
            {id: 'cua', i:'ü¶Ä', n:'Cua'}, {id: 'tom', i:'ü¶ê', n:'T√¥m'}
        ];
        
        let myName = '';
        let roomId = '';
        let myBalance = 0;
        let isShaking = false;
        let amIReady = false;
        let isHost = false; 
        let currentHostName = ''; // Bi·∫øn m·ªõi ƒë·ªÉ l∆∞u t√™n ch·ªß ph√≤ng
        
        let myCurrentBets = { nai:0, bau:0, ga:0, ca:0, cua:0, tom:0 };
        let currentGlobalBets = {}; 

        function validateBetInput(input) {
            let val = parseInt(input.value);
            if (isNaN(val) || val < 1) input.value = 1;
            if (val > 1000) input.value = 1000;
        }

        function initBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            mascots.forEach(m => {
                board.innerHTML += `
                    <div class="bet-item" onclick="placeBet('${m.id}')">
                        <div style="font-size:1.8rem">${m.i}</div>
                        <div style="font-weight:bold">${m.n}</div>
                        <span class="my-bet-badge" id="my-bet-${m.id}" style="display:none">0</span>
                        <div class="total-bet" id="total-${m.id}">0$</div>
                        <div class="detail-list" id="detail-${m.id}"></div>
                    </div>
                `;
            });
        }

        function joinGame() {
            const u = document.getElementById('username').value.trim().replace(/[.#$\[\]]/g, ""); 
            const r = document.getElementById('roomName').value.trim();
            const b = parseInt(document.getElementById('startBalance').value);

            if(!u || !r) return alert("Vui l√≤ng nh·∫≠p t√™n v√† ph√≤ng");
            if(isNaN(b) || b <= 0) return alert("Vui l√≤ng nh·∫≠p v·ªën");
            
            myName = u;
            roomId = r;
            myBalance = b;
            
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('displayName').innerText = myName;
            updateBalanceUI();
            
            initBoard();
            registerPlayer();
            listenToRoom();
        }

        function registerPlayer() {
            const playerRef = db.ref(`rooms/${roomId}/players/${myName}`);
            playerRef.set({ ready: false, online: true });
            playerRef.onDisconnect().remove();

            const hostRef = db.ref(`rooms/${roomId}/host`);
            hostRef.transaction((currentHost) => {
                if (currentHost === null) return myName; 
                return currentHost; 
            }, (error, committed, snapshot) => {
                if (error) return;
                const actualHost = snapshot.val();
                
                if (actualHost === myName) {
                    isHost = true;
                    document.getElementById('roleLabel').innerHTML = '<span class="host-badge">NH√Ä C√ÅI</span>';
                    alert("üëë B·∫†N L√Ä NH√Ä C√ÅI!");
                    
                    document.getElementById('shakeBtn').classList.remove('admin-only');
                    document.getElementById('adminPanel').classList.remove('admin-only');
                    document.getElementById('readyBtn').style.display = 'none';
                    document.querySelector('.bet-control-panel').style.display = 'none';

                    hostRef.onDisconnect().remove();
                } else {
                    isHost = false;
                    document.getElementById('roleLabel').innerHTML = '';
                    document.getElementById('log').innerText = `Ch·ªß c√°i: ${actualHost}`;
                }
            });
        }

        function toggleReady() {
            if (isShaking) return;
            amIReady = !amIReady;
            db.ref(`rooms/${roomId}/players/${myName}/ready`).set(amIReady);
            toggleReadyUI(amIReady);
        }

        function toggleReadyUI(ready) {
            const btn = document.getElementById('readyBtn');
            if(ready) {
                btn.innerText = "ƒê√É CH·ªêT";
                btn.classList.remove('btn-success');
                btn.style.background = '#e0e0e0'; btn.style.color = '#333';
            } else {
                btn.innerText = "CH·ªêT ƒê∆†N (Xong)";
                btn.classList.add('btn-success');
                btn.style.background = ''; btn.style.color = '';
            }
        }

        // --- PH·∫¶N S·ª¨A L·ªñI CH√çNH ·ªû ƒê√ÇY ---
        function listenToRoom() {
            const roomRef = db.ref('rooms/' + roomId);

            // 1. Nghe xem ai l√† Host ƒë·ªÉ c·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
            roomRef.child('host').on('value', snap => {
                currentHostName = snap.val();
            });

            // 2. Nghe danh s√°ch ng∆∞·ªùi ch∆°i
            roomRef.child('players').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const listEl = document.getElementById('playerList');
                listEl.innerHTML = '';
                
                let allPlayersReady = true;
                let activePlayerCount = 0; // S·ªë ng∆∞·ªùi ch∆°i (kh√¥ng t√≠nh c√°i)

                Object.keys(players).forEach(name => {
                    const p = players[name];

                    // N·∫øu l√† C√°i: Hi·ªÉn th·ªã kh√°c v√† KH√îNG t√≠nh v√†o logic Ready
                    if (name === currentHostName) {
                        listEl.innerHTML += `<div class="player-tag" style="border:2px solid red; font-weight:bold; color:#d32f2f">üëë C√°i: ${name}</div>`;
                        return; // B·ªè qua, kh√¥ng ch·∫°y d√≤ng check ready b√™n d∆∞·ªõi
                    }

                    // N·∫øu l√† Nh√† con
                    activePlayerCount++;
                    if (!p.ready) allPlayersReady = false; // Ch·ªâ c·∫ßn 1 nh√† con ch∆∞a ready l√† false

                    listEl.innerHTML += `<div class="player-tag ${p.ready ? 'ready' : ''}"><div class="status-dot"></div>${name}</div>`;
                });

                // Logic b·∫≠t n√∫t X√≥c cho C√°i
                const shakeBtn = document.getElementById('shakeBtn');
                if (isHost) {
                    // ƒêi·ªÅu ki·ªán: C√≥ √≠t nh·∫•t 1 nh√† con V√Ä t·∫•t c·∫£ nh√† con ƒë√£ ready
                    if (activePlayerCount > 0 && allPlayersReady) {
                        shakeBtn.disabled = false;
                        shakeBtn.classList.remove('btn-disabled');
                        shakeBtn.innerText = "X√ìC NGAY üé≤";
                    } else {
                        shakeBtn.disabled = true;
                        shakeBtn.classList.add('btn-disabled');
                        // Hi·ªÉn th·ªã ch·ªù ai ƒë√≥
                        shakeBtn.innerText = activePlayerCount === 0 ? "Ch·ªù ng∆∞·ªùi ch∆°i..." : "Ch·ªù nh√† con ch·ªët...";
                    }
                }
            });

            // C√°c listeners kh√°c gi·ªØ nguy√™n...
            roomRef.child('diceStatus').on('value', (snapshot) => {
                const status = snapshot.val(); 
                if(!status) return;
                const diceEls = [document.getElementById('d1'), document.getElementById('d2'), document.getElementById('d3')];
                
                if (status.shaking) {
                    document.getElementById('log').innerText = "Nh√† c√°i ƒëang x√≥c...";
                    diceEls.forEach(d => { d.classList.add('shaking'); d.innerText = 'üé≤'; });
                    isShaking = true;
                    if (!isHost) document.getElementById('readyBtn').disabled = true;
                } else if (status.result) {
                    diceEls.forEach((d, i) => {
                        d.classList.remove('shaking');
                        d.innerText = mascots[status.result[i]].i;
                    });
                    
                    if (isShaking) { 
                        if (isHost) calculateHostResult(status.result);
                        else calculatePlayerResult(status.result);
                        
                        findAndAnnounceBigWinner(status.result);
                        isShaking = false;
                        
                        if (!isHost) {
                            document.getElementById('readyBtn').disabled = false;
                            amIReady = false; 
                            db.ref(`rooms/${roomId}/players/${myName}/ready`).set(false);
                            toggleReadyUI(false);
                        }
                    }
                }
            });

            roomRef.child('bets').on('value', (snapshot) => {
                const allBetsData = snapshot.val() || {};
                currentGlobalBets = allBetsData;
                mascots.forEach(m => {
                    const mascotBets = allBetsData[m.id] || {};
                    let total = 0;
                    let myBetAmount = 0;
                    let detailsHTML = '';
                    Object.keys(mascotBets).forEach(player => {
                        const amount = mascotBets[player];
                        total += amount;
                        if (player === myName) myBetAmount = amount;
                        detailsHTML += `<div class="detail-item"><span>${player}</span><b>${amount}$</b></div>`;
                    });
                    document.getElementById(`total-${m.id}`).innerText = total + '$';
                    const badge = document.getElementById(`my-bet-${m.id}`);
                    if (myBetAmount > 0) { badge.style.display = 'block'; badge.innerText = myBetAmount; } 
                    else { badge.style.display = 'none'; }
                    document.getElementById(`detail-${m.id}`).innerHTML = detailsHTML;
                });
            });

            roomRef.child('command').on('value', (snapshot) => {
                const cmd = snapshot.val();
                if (!cmd) return;
                if (cmd.type === 'REFUND' && cmd.timestamp > (window.lastProcessedCmd || 0)) {
                    window.lastProcessedCmd = cmd.timestamp;
                    if (!isHost) {
                        let totalRefund = 0;
                        mascots.forEach(m => { totalRefund += myCurrentBets[m.id]; });
                        if (totalRefund > 0) {
                            myBalance += totalRefund;
                            alert(`‚ö† C√°i h·ªßy v√°n! ƒê√£ ho√†n l·∫°i ${totalRefund}$`);
                            updateBalanceUI();
                        }
                        resetLocalBets();
                    }
                    document.getElementById('log').innerText = "V√°n ƒë·∫•u b·ªã h·ªßy.";
                }
            });
        }

        // --- H√ÄNH ƒê·ªòNG C∆Ø·ª¢C ---
        function placeBet(mascotId) {
            if (isHost) return alert("B·∫°n l√† NH√Ä C√ÅI, kh√¥ng ƒë∆∞·ª£c ƒë·∫∑t c∆∞·ª£c!");
            if (isShaking) return alert("ƒêang x√≥c!");
            if (amIReady) return alert("ƒê√£ ch·ªët ƒë∆°n! H·ªßy ch·ªët ƒë·ªÉ c∆∞·ª£c th√™m.");
            
            const amountInput = document.getElementById('betInput');
            let betAmount = parseInt(amountInput.value);
            if (isNaN(betAmount) || betAmount < 1) betAmount = 1;
            
            if (myBalance < betAmount) return alert("Kh√¥ng ƒë·ªß ti·ªÅn!");

            myBalance -= betAmount;
            updateBalanceUI();
            
            myCurrentBets[mascotId] += betAmount;

            const betRef = db.ref(`rooms/${roomId}/bets/${mascotId}/${myName}`);
            betRef.transaction((current) => (current || 0) + betAmount);
        }

        // --- T√çNH TI·ªÄN ---
        function calculatePlayerResult(resultIndices) {
            let totalBet = 0;
            let totalReturn = 0;
            let totalProfit = 0;
            const winningIds = resultIndices.map(i => mascots[i].id);

            mascots.forEach(m => {
                const betAmount = myCurrentBets[m.id];
                if (betAmount > 0) {
                    totalBet += betAmount;
                    const count = winningIds.filter(id => id === m.id).length;
                    if (count > 0) {
                        totalReturn += betAmount;
                        totalProfit += betAmount * count;
                    }
                }
            });

            const totalReceived = totalReturn + totalProfit;
            const netResult = totalReceived - totalBet;

            if (totalReceived > 0) myBalance += totalReceived;
            updateBalanceUI();
            playSound(netResult);

            let msg = "";
            if (netResult > 0) msg = `üéâ ƒÇn c·ªßa C√°i: +${netResult}$`;
            else if (netResult === 0) msg = `üòê H√≤a v·ªën`;
            else msg = `üí∏ C√∫ng cho C√°i: ${Math.abs(netResult)}$`;
            document.getElementById('log').innerText = msg;
            resetLocalBets();
        }

        function calculateHostResult(resultIndices) {
            const winningIds = resultIndices.map(i => mascots[i].id);
            let totalRevenue = 0; 
            let totalPayout = 0;  

            mascots.forEach(m => {
                const betsOnMascot = currentGlobalBets[m.id] || {};
                Object.values(betsOnMascot).forEach(amount => {
                    totalRevenue += amount; 
                    const count = winningIds.filter(id => id === m.id).length;
                    if (count > 0) totalPayout += amount + (amount * count);
                });
            });

            const netIncome = totalRevenue - totalPayout;
            myBalance += netIncome;
            updateBalanceUI();
            playSound(netIncome);

            let msg = "";
            if (netIncome > 0) msg = `ü§ë C√°i ƒÉn: +${netIncome}$`;
            else if (netIncome === 0) msg = `üòê C√°i h√≤a ti·ªÅn`;
            else msg = `üò≠ C√°i ƒë·ªÅn l√†ng: ${netIncome}$`;
            document.getElementById('log').innerText = msg;
        }

        function playSound(amount) {
            if (amount > 0) document.getElementById('soundWin').play().catch(()=>{});
            else if (amount < 0) document.getElementById('soundLose').play().catch(()=>{});
        }

        function findAndAnnounceBigWinner(resultIndices) {
            const winningIds = resultIndices.map(i => mascots[i].id);
            let playerProfits = {};

            mascots.forEach(m => {
                const betsOnMascot = currentGlobalBets[m.id] || {};
                Object.keys(betsOnMascot).forEach(player => {
                    const amount = betsOnMascot[player];
                    if (!playerProfits[player]) playerProfits[player] = 0;
                    const count = winningIds.filter(id => id === m.id).length;
                    if (count > 0) playerProfits[player] += amount * count;
                    else playerProfits[player] -= amount;
                });
            });

            let maxProfit = -999999999;
            let winnerName = '';
            for (const [player, profit] of Object.entries(playerProfits)) {
                if (profit > maxProfit) {
                    maxProfit = profit;
                    winnerName = player;
                }
            }
            if (winnerName && winnerName !== currentHostName && maxProfit > 0) {
                document.getElementById('winName').innerText = winnerName;
                document.getElementById('winAmount').innerText = `+${maxProfit}$`;
                document.getElementById('winnerOverlay').style.display = 'flex';
                setTimeout(() => { document.getElementById('winnerOverlay').style.display = 'none'; }, 4000);
            }
        }
        
        function closeWinnerPopup() { document.getElementById('winnerOverlay').style.display = 'none'; }
        function updateBalanceUI() { document.getElementById('displayBalance').innerText = myBalance; }
        function resetLocalBets() { mascots.forEach(m => myCurrentBets[m.id] = 0); }

        function requestShake() {
            if (!isHost) return alert("Ch·ªâ NH√Ä C√ÅI m·ªõi ƒë∆∞·ª£c X√≥c!");
            
            // Logic x√≥c: Ki·ªÉm tra k·ªπ l·∫°i m·ªôt l·∫ßn n·ªØa xem c√≥ ai ch∆∞a ready kh√¥ng (tr·ª´ b·∫£n th√¢n C√°i)
            db.ref(`rooms/${roomId}/players`).once('value', snap => {
                const players = snap.val() || {};
                let allReady = true;
                let activePlayerCount = 0;

                Object.keys(players).forEach(name => {
                    if (name !== currentHostName) { // B·ªè qua C√°i
                        activePlayerCount++;
                        if (!players[name].ready) allReady = false;
                    }
                });

                if (activePlayerCount === 0) return alert("Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o!");
                if (!allReady) return alert("V·∫´n c√≤n nh√† con ch∆∞a ch·ªët ƒë∆°n!");

                db.ref(`rooms/${roomId}/diceStatus`).set({ shaking: true });
                setTimeout(() => {
                    const r = [0,0,0].map(() => Math.floor(Math.random() * 6));
                    db.ref(`rooms/${roomId}/diceStatus`).set({ shaking: false, result: r });
                }, 2000);
            });
        }

        function triggerRefund() {
            if(!confirm("C√°i mu·ªën h·ªßy v√°n & tr·∫£ l·∫°i ti·ªÅn?")) return;
            db.ref(`rooms/${roomId}/command`).set({ type: 'REFUND', timestamp: firebase.database.ServerValue.TIMESTAMP });
            setTimeout(() => {
                db.ref(`rooms/${roomId}/bets`).set(null);
                resetAllPlayersReady();
            }, 1000);
        }

        function clearTable() {
            if(!confirm("D·ªçn b√†n v√°n m·ªõi?")) return;
            db.ref(`rooms/${roomId}/bets`).set(null);
            resetAllPlayersReady();
        }

        function resetAllPlayersReady() {
            db.ref(`rooms/${roomId}/players`).once('value', snap => {
                snap.forEach(child => { child.ref.update({ ready: false }); });
            });
        }
    </script>
</body>
</html>
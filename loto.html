<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¥ T√¥ Online 10A2</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --main-color: #e91e63; --accent: #ffeb3b; }
        body { font-family: 'Segoe UI', sans-serif; background: #fce4ec; text-align: center; margin: 0; padding: 10px; }
        
        /* M√†n h√¨nh ƒëƒÉng nh·∫≠p */
        .screen { display: none; }
        .active { display: block; }
        #loginScreen { background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: 50px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, button { padding: 12px; width: 90%; margin: 5px 0; border-radius: 5px; border: 1px solid #ddd; }
        button { background: var(--main-color); color: white; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; }
        button:hover { opacity: 0.9; }

        /* Game UI */
        .header-info { display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; }
        
        /* V√≤ng quay s·ªë */
        .ball-display {
            width: 120px; height: 120px; background: var(--main-color); color: white;
            border-radius: 50%; margin: 10px auto; display: flex; align-items: center; justify-content: center;
            font-size: 4rem; font-weight: bold; border: 5px solid white; box-shadow: 0 5px 15px rgba(233, 30, 99, 0.4);
        }
        .last-balls { font-size: 0.9rem; color: #666; margin-bottom: 10px; height: 20px; overflow: hidden;}

        /* T·ªù v√© s·ªë */
        .ticket {
            background: white; padding: 10px; border-radius: 10px; margin: 10px auto;
            max-width: 600px; border: 2px solid var(--main-color);
        }
        .ticket-row { display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; margin-bottom: 2px; }
        .cell {
            aspect-ratio: 1; border: 1px solid #eee; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1rem; background: #fafafa; position: relative;
        }
        .cell.has-number { background: #fff; color: #333; }
        .cell.marked { background: var(--accent); color: #d32f2f; border-color: #fbc02d; }
        .cell.empty { background: #e0e0e0; }

        /* B·∫£ng d√≤ s·ªë (D√†nh cho ai mu·ªën check) */
        .check-board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; font-size: 0.7rem; max-width: 400px; margin: 20px auto; }
        .cb-num { padding: 2px; background: #ddd; border-radius: 2px; }
        .cb-num.active { background: var(--main-color); color: white; }

        .controls { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 10px;}
        .hidden { display: none !important; }
        
        /* Hi·ªáu ·ª©ng */
        .win-btn { background: #4caf50; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active">
        <h1 style="color: var(--main-color)">L√î T√î S√ÄI G√íN</h1>
        <input type="text" id="username" placeholder="T√™n b·∫°n (VD: Ki·ªát)">
        <input type="text" id="roomName" placeholder="T√™n ph√≤ng (VD: 10a2)">
        <button onclick="joinGame()">V√ÄO CH∆†I</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="header-info">
            <span>Ph√≤ng: <b id="displayRoom">...</b></span>
            <span><b id="roleDisplay">...</b></span>
        </div>

        <div class="ball-display" id="currentBall">--</div>
        <div class="last-balls" id="logBalls">Ch·ªù quay s·ªë...</div>

        <h3 style="margin:5px">V√â C·ª¶A B·∫†N</h3>
        <div class="ticket" id="myTicket"></div>

        <div id="playerActions" class="hidden" style="margin-bottom: 60px;">
            <button class="win-btn" onclick="claimWin('KINH')">üéâ KINH (ƒÇn d√≤ng)</button>
            <button class="win-btn" style="background:#f44336" onclick="claimWin('CHUNG')">üèÜ CHUNG (ƒÇn h·∫øt)</button>
        </div>

        <details>
            <summary>M·ªü b·∫£ng d√≤ s·ªë (1-90)</summary>
            <div class="check-board" id="checkBoard"></div>
        </details>

        <div id="hostControls" class="controls hidden">
            <button onclick="drawNumber()">QUAY S·ªê</button>
            <button onclick="resetGame()" style="background:#666">V√°n m·ªõi</button>
            <label style="display:flex; align-items:center; gap:5px; font-size:0.8rem;">
                <input type="checkbox" id="voiceToggle" checked> ƒê·ªçc s·ªë
            </label>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH (D√ÅN CONFIG C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDezhyeDURAA_WfX8xxhGJ7KcNTVM8cwO4",
            authDomain: "tuankiet-gametet.firebaseapp.com",
            projectId: "tuankiet-gametet",
            storageBucket: "tuankiet-gametet.firebasestorage.app",
            messagingSenderId: "406766414133",
            appId: "1:406766414133:web:e4a99221da90dcc657847c",
            databaseURL: "https://tuankiet-gametet-default-rtdb.firebaseio.com"
        };
        // ----------------------------------------------

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName, roomId, isHost = false;
        let drawnNumbers = [];
        let myTicketData = []; // M·∫£ng 3 d√≤ng, m·ªói d√≤ng 9 ph·∫ßn t·ª≠ (s·ªë ho·∫∑c null)

        // T·∫°o b·∫£ng d√≤ 1-90
        const boardEl = document.getElementById('checkBoard');
        for(let i=1; i<=90; i++) {
            boardEl.innerHTML += `<div class="cb-num" id="cb-${i}">${i}</div>`;
        }

        function joinGame() {
            myName = document.getElementById('username').value.trim();
            roomId = document.getElementById('roomName').value.trim();
            if(!myName || !roomId) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");

            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('displayRoom').innerText = roomId;

            // ƒêƒÉng k√Ω Host
            db.ref(`loto/${roomId}/host`).transaction(curr => curr || myName, (err, committed, snap) => {
                if(committed && snap.val() === myName) {
                    isHost = true;
                    document.getElementById('roleDisplay').innerText = "B·∫°n l√† C√°i (Host)";
                    document.getElementById('hostControls').classList.remove('hidden');
                } else {
                    document.getElementById('roleDisplay').innerText = "Tay em";
                    document.getElementById('playerActions').classList.remove('hidden');
                }
            });

            generateTicket(); // T·∫°o v√© cho ri√™ng m√¨nh
            listenGame();
        }

        // --- THU·∫¨T TO√ÅN T·∫†O V√â L√î T√î (C∆° b·∫£n) ---
        function generateTicket() {
            // Quy t·∫Øc: 3 d√≤ng, 9 c·ªôt. 
            // C·ªôt 1 (1-9), C·ªôt 2 (10-19)... C·ªôt 9 (80-90)
            // M·ªói d√≤ng ph·∫£i c√≥ ƒë√∫ng 5 s·ªë.
            myTicketData = [[], [], []];
            const colRanges = [
                [1,9], [10,19], [20,29], [30,39], [40,49], 
                [50,59], [60,69], [70,79], [80,90]
            ];

            // 1. Fill s·ªë ng·∫´u nhi√™n v√†o c√°c c·ªôt cho ƒë·ªß ƒëi·ªÅu ki·ªán (m·ªói c·ªôt √≠t nh·∫•t 1 s·ªë n·∫øu ch∆°i chu·∫©n, nh∆∞ng ƒë·ªÉ ƒë∆°n gi·∫£n ta random theo d√≤ng)
            // C√°ch ƒë∆°n gi·∫£n h√≥a: M·ªói d√≤ng ch·ªçn random 5 c·ªôt ƒë·ªÉ ƒëi·ªÅn s·ªë
            for (let r = 0; r < 3; r++) {
                let row = new Array(9).fill(null);
                // Ch·ªçn 5 c·ªôt ng·∫´u nhi√™n t·ª´ 0-8
                let cols = [];
                while(cols.length < 5) {
                    let c = Math.floor(Math.random() * 9);
                    if(!cols.includes(c)) cols.push(c);
                }
                
                // ƒêi·ªÅn s·ªë v√†o 5 c·ªôt ƒë√≥
                cols.forEach(c => {
                    let min = colRanges[c][0];
                    let max = colRanges[c][1];
                    let num;
                    // ƒê·∫£m b·∫£o kh√¥ng tr√πng s·ªë trong c√πng 1 c·ªôt c·ªßa c√°c d√≤ng tr∆∞·ªõc
                    do {
                        num = Math.floor(Math.random() * (max - min + 1)) + min;
                    } while (
                        (r > 0 && myTicketData[r-1][c] === num) || 
                        (r > 1 && myTicketData[r-2][c] === num)
                    );
                    row[c] = num;
                });
                myTicketData[r] = row;
            }
            renderTicketUI();
        }

        function renderTicketUI() {
            const ticketEl = document.getElementById('myTicket');
            ticketEl.innerHTML = '';
            myTicketData.forEach((row, rIndex) => {
                let rowHtml = '<div class="ticket-row">';
                row.forEach((num, cIndex) => {
                    if (num === null) {
                        rowHtml += `<div class="cell empty"></div>`;
                    } else {
                        // Check xem s·ªë ƒë√£ ra ch∆∞a ƒë·ªÉ highlight
                        const isMarked = drawnNumbers.includes(num);
                        rowHtml += `<div class="cell has-number ${isMarked ? 'marked' : ''}" id="cell-${num}">${num}</div>`;
                    }
                });
                rowHtml += '</div>';
                ticketEl.innerHTML += rowHtml;
            });
        }

        // --- GAME LOGIC ---
        function listenGame() {
            const roomRef = db.ref(`loto/${roomId}`);
            
            roomRef.child('currentNumber').on('value', snap => {
                const num = snap.val();
                if(num) {
                    document.getElementById('currentBall').innerText = num;
                    if(!drawnNumbers.includes(num)) {
                        drawnNumbers.push(num);
                        document.getElementById('logBalls').innerText = "ƒê√£ ra: " + drawnNumbers.slice(-10).join(', ');
                        
                        // Highlight tr√™n v√©
                        const cell = document.getElementById(`cell-${num}`);
                        if(cell) cell.classList.add('marked');
                        
                        // Highlight b·∫£ng d√≤
                        document.getElementById(`cb-${num}`).classList.add('active');

                        // ƒê·ªçc s·ªë (N·∫øu b·∫≠t)
                        speakNumber(num);
                    }
                } else {
                    // Reset
                    document.getElementById('currentBall').innerText = "--";
                    drawnNumbers = [];
                    document.querySelectorAll('.cell').forEach(e => e.classList.remove('marked'));
                    document.querySelectorAll('.cb-num').forEach(e => e.classList.remove('active'));
                }
            });

            roomRef.child('winner').on('value', snap => {
                if(snap.val()) alert(`üì¢ LOA LOA: ${snap.val()} ƒê√É TR√öNG TH∆Ø·ªûNG!`);
            });
        }

        // --- HOST ACTIONS ---
        function drawNumber() {
            if(drawnNumbers.length >= 90) return alert("H·∫øt s·ªë r·ªìi!");
            let num;
            do {
                num = Math.floor(Math.random() * 90) + 1;
            } while (drawnNumbers.includes(num));

            // Hi·ªáu ·ª©ng quay s·ªë gi·∫£ tr√¢n
            let count = 0;
            const interval = setInterval(() => {
                document.getElementById('currentBall').innerText = Math.floor(Math.random()*90)+1;
                count++;
                if(count > 10) {
                    clearInterval(interval);
                    // G·ª≠i s·ªë ch·ªët l√™n server
                    db.ref(`loto/${roomId}/currentNumber`).set(num);
                }
            }, 50);
        }

        function resetGame() {
            if(confirm("Ch∆°i v√°n m·ªõi? (M·ªçi ng∆∞·ªùi s·∫Ω b·ªã reset v√©)")) {
                 db.ref(`loto/${roomId}`).set({ host: myName });
                 // Reload l·∫°i trang ƒë·ªÉ t·∫°o v√© m·ªõi
                 setTimeout(() => location.reload(), 500);
            }
        }

        // --- PLAYER ACTIONS ---
        function claimWin(type) {
            // Ch·ªâ g·ª≠i th√¥ng b√°o th√¥i, ki·ªÉm tra b·∫±ng c∆°m cho vui
            db.ref(`loto/${roomId}/winner`).set(`${myName} h√¥ ${type}`);
        }

        // --- VOICE (Gi·ªçng ch·ªã Google) ---
        function speakNumber(num) {
            if(!document.getElementById('voiceToggle') || !document.getElementById('voiceToggle').checked) return;
            
            // C√¢u d·∫´n vui v·∫ª
            const phrases = ["S·ªë g√¨ ƒë√¢y, s·ªë g√¨ ƒë√¢y", "Con s·ªë", "L√¥ t√¥", "C·ªù ra con m·∫•y"];
            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            
            const msg = new SpeechSynthesisUtterance(`${randomPhrase}. S·ªë ${num}. Con s·ªë ${num}.`);
            msg.lang = 'vi-VN';
            window.speechSynthesis.speak(msg);
        }

    </script>
</body>
</html>
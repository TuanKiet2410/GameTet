<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·ªç C√°nh Cam T√¨m S·ªë 10A2</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --bg-color: #8bc34a; --hole-color: #33691e; --bug-size: 50px; }
        body { font-family: 'Verdana', sans-serif; background-color: var(--bg-color); text-align: center; margin: 0; padding: 10px; overflow-x: hidden; }
        
        /* M√†n h√¨nh ƒëƒÉng nh·∫≠p */
        .screen { display: none; }
        .active { display: block; }
        #loginScreen { background: white; padding: 20px; border-radius: 15px; max-width: 400px; margin: 50px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        input, button { padding: 12px; width: 90%; margin: 5px 0; border-radius: 20px; border: 1px solid #ccc; font-size: 1rem; }
        button { background: #ff5722; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { transform: scale(1.05); }

        /* S√¢n ch∆°i */
        .garden { 
            position: relative; width: 350px; height: 350px; margin: 20px auto; 
            background: #aed581; border-radius: 50%; border: 8px solid #558b2f;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }

        /* C√°c l·ªó s·ªë */
        .hole {
            position: absolute; width: 50px; height: 50px; 
            background: var(--hole-color); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 3px solid #fff; cursor: pointer;
            box-shadow: 0 4px 0 #1b5e20; transition: transform 0.1s;
        }
        .hole:active { transform: translateY(4px); box-shadow: none; }
        .hole.selected { border-color: #ffeb3b; background: #ff9800; transform: scale(1.1); }
        .hole.winner { background: #ff5722; animation: flash 0.5s infinite; }

        /* Con b·ªç */
        #bug {
            position: absolute; width: var(--bug-size); height: var(--bug-size);
            font-size: 2.5rem; line-height: var(--bug-size);
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            transition: all 0.3s ease-in-out; /* Chuy·ªÉn ƒë·ªông m∆∞·ª£t */
            z-index: 10; pointer-events: none;
        }

        .controls { margin-top: 20px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 10px; display: inline-block; }
        .info-bar { font-weight: bold; color: #1b5e20; margin-bottom: 10px; }
        .hidden { display: none !important; }

        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active">
        <h1 style="color: #ff5722">üêû B·ªå T√åM S·ªê üêû</h1>
        <input type="text" id="username" placeholder="T√™n b·∫°n (VD: T√®o)">
        <input type="text" id="roomName" placeholder="T√™n ph√≤ng (VD: 10a2)">
        <button onclick="joinGame()">V√ÄO V∆Ø·ªúN</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="info-bar">
            Ph√≤ng: <span id="displayRoom">...</span> | <span id="statusText">Ch·ªçn m·ªôt s·ªë ƒëi!</span>
        </div>

        <div class="garden" id="garden">
            <div id="bug">üêû</div>
            </div>

        <div class="controls">
            <div>B·∫°n ch·ªçn: <b id="myChoice" style="color:red">Ch∆∞a ch·ªçn</b></div>
            <div id="hostControls" class="hidden" style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px">
                <button onclick="startRun()">TH·∫¢ B·ªå (Quay)</button>
                <button onclick="resetGame()" style="background:#555">Ch·ªçn l·∫°i</button>
            </div>
        </div>
        
        <div id="winnerAnnounce" style="margin-top:15px; font-weight:bold; color: #d84315; font-size: 1.2rem;"></div>
    </div>

    <script>
        // --- C·∫§U H√åNH (THAY ƒêO·∫†N CONFIG C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDezhyeDURAA_WfX8xxhGJ7KcNTVM8cwO4",
            authDomain: "tuankiet-gametet.firebaseapp.com",
            projectId: "tuankiet-gametet",
            storageBucket: "tuankiet-gametet.firebasestorage.app",
            messagingSenderId: "406766414133",
            appId: "1:406766414133:web:e4a99221da90dcc657847c",
            databaseURL: "https://tuankiet-gametet-default-rtdb.firebaseio.com"
        };
        // ----------------------------------------------------

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName, roomId, isHost = false;
        const totalHoles = 10; // S·ªë l∆∞·ª£ng l·ªó (1-10)
        let isRunning = false;
        let positions = []; // L∆∞u t·ªça ƒë·ªô c√°c l·ªó

        // 1. T·∫°o giao di·ªán c√°c l·ªó x·∫øp th√†nh v√≤ng tr√≤n
        function initGarden() {
            const garden = document.getElementById('garden');
            const radius = 130; // B√°n k√≠nh v√≤ng tr√≤n
            const centerX = 175; // T√¢m X (1/2 width garden)
            const centerY = 175; // T√¢m Y

            for (let i = 1; i <= totalHoles; i++) {
                // C√¥ng th·ª©c to√°n h·ªçc t√≠nh t·ªça ƒë·ªô v√≤ng tr√≤n
                const angle = (i * (360 / totalHoles)) - 90; // -90 ƒë·ªÉ s·ªë 1 n·∫±m tr√™n ƒë·ªânh
                const radian = angle * (Math.PI / 180);
                const x = centerX + radius * Math.cos(radian) - 25; // -25 l√† n·ª≠a size l·ªó
                const y = centerY + radius * Math.sin(radian) - 25;

                const hole = document.createElement('div');
                hole.className = 'hole';
                hole.id = `hole-${i}`;
                hole.innerText = i;
                hole.style.left = `${x}px`;
                hole.style.top = `${y}px`;
                hole.onclick = () => chooseNumber(i);
                
                garden.appendChild(hole);
                positions[i] = {x: x + 25, y: y + 25}; // L∆∞u t√¢m l·ªó ƒë·ªÉ b·ªç b√≤ t·ªõi
            }
        }

        function joinGame() {
            myName = document.getElementById('username').value.trim();
            roomId = document.getElementById('roomName').value.trim();
            if(!myName || !roomId) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");

            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('displayRoom').innerText = roomId;
            initGarden();

            // ƒêƒÉng k√Ω Host
            db.ref(`buggame/${roomId}/host`).transaction(curr => curr || myName, (err, committed, snap) => {
                if(committed && snap.val() === myName) {
                    isHost = true;
                    document.getElementById('hostControls').classList.remove('hidden');
                }
            });

            listenGame();
        }

        function listenGame() {
            // Nghe tr·∫°ng th√°i con b·ªç
            db.ref(`buggame/${roomId}`).on('value', snap => {
                const data = snap.val() || {};
                
                // Hi·ªÉn th·ªã ng∆∞·ªùi th·∫Øng
                if(data.winner) {
                    document.getElementById('statusText').innerText = `K·∫øt qu·∫£: S·ªë ${data.winner}`;
                    highlightWinner(data.winner);
                    document.getElementById('winnerAnnounce').innerText = (data.winner == myChoice) ? "üéâ B·∫†N TH·∫ÆNG R·ªíI!" : "Ch√∫c may m·∫Øn l·∫ßn sau";
                } else if (data.isRunning) {
                    document.getElementById('statusText').innerText = "B·ªç ƒëang t√¨m ch·ªó tr·ªën...";
                    document.getElementById('winnerAnnounce').innerText = "";
                    runAnimation(true); // B·∫Øt ƒë·∫ßu ch·∫°y hi·ªáu ·ª©ng gi·∫£
                } else {
                    // Tr·∫°ng th√°i ch·ªù
                    resetVisuals();
                    document.getElementById('statusText').innerText = "M·ªùi ƒë·∫∑t c∆∞·ª£c";
                }
            });
        }

        let myChoice = null;
        function chooseNumber(num) {
            if(isRunning) return;
            // X√≥a ch·ªçn c≈©
            if(myChoice) document.getElementById(`hole-${myChoice}`).classList.remove('selected');
            
            myChoice = num;
            document.getElementById(`hole-${num}`).classList.add('selected');
            document.getElementById('myChoice').innerText = `S·ªë ${num}`;
        }

        // --- HOST: ƒêI·ªÄU KHI·ªÇN ---
        function startRun() {
            if(!isHost) return;
            // G·ª≠i t√≠n hi·ªáu ƒëang ch·∫°y
            db.ref(`buggame/${roomId}`).update({ isRunning: true, winner: null });
            
            // Random k·∫øt qu·∫£ sau 3 gi√¢y
            setTimeout(() => {
                const winningNum = Math.floor(Math.random() * totalHoles) + 1;
                db.ref(`buggame/${roomId}`).update({ isRunning: false, winner: winningNum });
            }, 4000);
        }

        function resetGame() {
            db.ref(`buggame/${roomId}`).update({ isRunning: false, winner: null });
        }

        // --- HI·ªÜU ·ª®NG ANIMATION ---
        let animInterval;
        function runAnimation(isStart) {
            const bug = document.getElementById('bug');
            isRunning = isStart;
            
            if(isStart) {
                // Cho b·ªç ch·∫°y lo·∫°n x·∫°
                animInterval = setInterval(() => {
                    const randHole = Math.floor(Math.random() * totalHoles) + 1;
                    const pos = positions[randHole];
                    // Th√™m ch√∫t l·ªách ng·∫´u nhi√™n cho t·ª± nhi√™n
                    const offsetX = (Math.random() - 0.5) * 20;
                    const offsetY = (Math.random() - 0.5) * 20;
                    
                    bug.style.left = (pos.x + offsetX) + 'px';
                    bug.style.top = (pos.y + offsetY) + 'px';
                    bug.style.transform = `translate(-50%, -50%) rotate(${Math.random()*360}deg)`;
                }, 200); // T·ªëc ƒë·ªô ch·∫°y (200ms ƒë·ªïi ch·ªó 1 l·∫ßn)
            } else {
                clearInterval(animInterval);
            }
        }

        function highlightWinner(num) {
            clearInterval(animInterval);
            isRunning = false;
            
            // ƒê∆∞a b·ªç v·ªÅ ƒë√∫ng l·ªó th·∫Øng
            const bug = document.getElementById('bug');
            const pos = positions[num];
            bug.style.left = pos.x + 'px';
            bug.style.top = pos.y + 'px';
            bug.style.transform = 'translate(-50%, -50%) scale(1.5)'; // B·ªç to l√™n

            // S√°ng ƒë√®n l·ªó
            document.querySelectorAll('.hole').forEach(h => h.classList.remove('winner'));
            document.getElementById(`hole-${num}`).classList.add('winner');
        }

        function resetVisuals() {
            clearInterval(animInterval);
            isRunning = false;
            document.querySelectorAll('.hole').forEach(h => h.classList.remove('winner'));
            // B·ªç v·ªÅ gi·ªØa
            const bug = document.getElementById('bug');
            bug.style.left = '50%';
            bug.style.top = '50%';
            bug.style.transform = 'translate(-50%, -50%)';
        }

    </script>
</body>
</html>
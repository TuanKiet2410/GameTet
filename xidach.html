<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√¨ D√°ch Online 10A2</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --main-color: #2e7d32; --card-w: 60px; --card-h: 84px; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--main-color); color: white; text-align: center; margin: 0; padding: 10px; }
        
        /* M√†n h√¨nh ƒëƒÉng nh·∫≠p */
        .screen { display: none; }
        .active { display: block; }
        #loginScreen { background: white; color: #333; padding: 20px; border-radius: 10px; max-width: 400px; margin: 50px auto; }
        input, button { padding: 10px; width: 90%; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #ffeb3b; border: none; font-weight: bold; cursor: pointer; color: #333; }
        
        /* B√†n ch∆°i */
        .game-board { max-width: 800px; margin: 0 auto; }
        .dealer-area { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 20px; min-height: 120px; }
        .player-area { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .my-area { border: 2px solid #ffeb3b; background: rgba(0,0,0,0.3); }
        
        /* L√° b√†i */
        .hand { display: flex; justify-content: center; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .card { 
            width: var(--card-w); height: var(--card-h); 
            background: white; color: #333; border-radius: 5px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-weight: bold; font-size: 1.2rem; position: relative;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        .card.red { color: #d32f2f; }
        .card.black { color: #333; }
        .card-back { background: #b71c1c; border: 2px solid white; background-image: linear-gradient(45deg, #b71c1c 25%, #d32f2f 25%, #d32f2f 50%, #b71c1c 50%, #b71c1c 75%, #d32f2f 75%, #d32f2f 100%); background-size: 10px 10px; }
        
        .score-badge { background: #333; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-top: 5px; display: inline-block;}
        .controls { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); padding: 10px; display: flex; justify-content: center; gap: 10px; }
        .hidden { display: none !important; }
        .status-msg { color: #ffeb3b; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active">
        <h1>‚ô£Ô∏è X√å D√ÅCH 10A2 ‚ô†Ô∏è</h1>
        <input type="text" id="username" placeholder="T√™n b·∫°n (VD: Ki·ªát)">
        <input type="text" id="roomName" placeholder="T√™n ph√≤ng (VD: 10a2)">
        <button onclick="joinGame()">V√†o S√≤ng</button>
    </div>

    <div id="gameScreen" class="screen game-board">
        <div style="display:flex; justify-content:space-between; padding:5px;">
            <span>Ph√≤ng: <b id="displayRoom">...</b></span>
            <span id="roleDisplay">...</span>
        </div>

        <div class="dealer-area">
            <h3>üëë NH√Ä C√ÅI <span id="dealerName"></span></h3>
            <div class="hand" id="dealerHand"></div>
            <div class="score-badge" id="dealerScore">? ƒëi·ªÉm</div>
        </div>

        <div id="msg" class="status-msg"></div>

        <div class="player-area my-area">
            <h3>üë§ B·∫†N (<span id="myName"></span>)</h3>
            <div class="hand" id="myHand"></div>
            <div class="score-badge" id="myScore">0 ƒëi·ªÉm</div>
        </div>

        <div id="otherPlayers"></div>

        <div style="height: 60px;"></div> </div>

    <div id="controls" class="controls hidden">
        <div id="hostControls" class="hidden">
            <button onclick="startGame()">CHIA B√ÄI M·ªöI</button>
            <button onclick="dealerHit()">C√°i R√∫t</button>
            <button onclick="revealAll()" style="background:orange">L·∫¨T B√ÄI C√ÅI</button>
        </div>
        <div id="playerControls" class="hidden">
            <button onclick="hit()">R√öT B√ÄI</button>
            <button onclick="stand()" style="background:#ddd">D·∫∞N (Th√¥i)</button>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH --- (D√ÅN CONFIG C·ª¶A B·∫†N V√ÄO ƒê√ÇY)
        const firebaseConfig = {
            apiKey: "AIzaSyDezhyeDURAA_WfX8xxhGJ7KcNTVM8cwO4",
            authDomain: "tuankiet-gametet.firebaseapp.com",
            projectId: "tuankiet-gametet",
            storageBucket: "tuankiet-gametet.firebasestorage.app",
            messagingSenderId: "406766414133",
            appId: "1:406766414133:web:e4a99221da90dcc657847c",
            databaseURL: "https://tuankiet-gametet-default-rtdb.firebaseio.com"
        };
        // ----------------

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "";
        let roomId = "";
        let isHost = false;
        let gameStatus = "waiting"; // waiting, playing, revealing
        let deck = [];

        function joinGame() {
            myName = document.getElementById('username').value.trim();
            roomId = document.getElementById('roomName').value.trim();
            if(!myName || !roomId) return alert("Nh·∫≠p ƒë·ªß t√™n v√† ph√≤ng!");

            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('displayRoom').innerText = roomId;
            document.getElementById('myName').innerText = myName;

            // ƒêƒÉng k√Ω v√†o ph√≤ng
            const pRef = db.ref(`blackjack/${roomId}/players/${myName}`);
            pRef.set({ name: myName, hand: [], score: 0, status: 'ready' });
            pRef.onDisconnect().remove(); // Tho√°t th√¨ x√≥a t√™n

            // Ki·ªÉm tra xem ai l√† Ch·ªß Ph√≤ng (ng∆∞·ªùi v√†o ƒë·∫ßu ti√™n ho·∫∑c ƒëc set)
            db.ref(`blackjack/${roomId}/host`).transaction((current) => {
                if (current === null) return myName; // Ch∆∞a c√≥ ai th√¨ m√¨nh l√†m ch·ªß
                return current;
            }, (error, committed, snapshot) => {
                if (committed && snapshot.val() === myName) {
                    isHost = true;
                    document.getElementById('roleDisplay').innerText = "(B·∫°n l√† Nh√† C√°i)";
                    document.getElementById('hostControls').classList.remove('hidden');
                } else {
                    document.getElementById('roleDisplay').innerText = "(B·∫°n l√† Nh√† Con)";
                }
            });

            listenGame();
        }

        function listenGame() {
            // Nghe to√†n b·ªô ph√≤ng
            db.ref(`blackjack/${roomId}`).on('value', snap => {
                const data = snap.val() || {};
                const players = data.players || {};
                const dealer = data.dealer || { hand: [], score: 0 };
                gameStatus = data.status || 'waiting';
                const hostName = data.host || "Ch∆∞a c√≥";

                document.getElementById('dealerName').innerText = hostName;
                document.getElementById('msg').innerText = data.message || "";

                // Render Nh√† C√°i
                renderHand('dealerHand', dealer.hand, (gameStatus === 'revealing' || isHost), true);
                document.getElementById('dealerScore').innerText = (gameStatus === 'revealing' || isHost) ? getScoreText(dealer.hand) : "?";

                // Render T√¥i
                const myData = players[myName] || { hand: [] };
                renderHand('myHand', myData.hand, true, false);
                document.getElementById('myScore').innerText = getScoreText(myData.hand);

                // Hi·ªÉn th·ªã n√∫t ch∆°i n·∫øu ƒëang playing
                if (!isHost) {
                    const controls = document.getElementById('playerControls');
                    if (gameStatus === 'playing' && myData.status !== 'stand') controls.classList.remove('hidden');
                    else controls.classList.add('hidden');
                }

                // Render ng∆∞·ªùi kh√°c
                const otherDiv = document.getElementById('otherPlayers');
                otherDiv.innerHTML = '';
                Object.values(players).forEach(p => {
                    if (p.name === myName) return;
                    otherDiv.innerHTML += `
                        <div class="player-area">
                            <div><b>${p.name}</b> (${p.status === 'stand' ? 'ƒê√£ d·∫±n' : 'ƒêang nghƒ©'})</div>
                            <div class="hand">
                                ${p.hand ? p.hand.map(c => `<div class="card card-back" style="width:30px;height:42px"></div>`).join('') : ''}
                            </div>
                            ${gameStatus === 'revealing' ? `<div class="score-badge">${getScoreText(p.hand)}</div>` : ''}
                        </div>
                    `;
                });
            });
        }

        // --- LOGIC GAME (Ch·ªâ Host ch·∫°y c√°i n√†y) ---
        function startGame() {
            if(!isHost) return;
            // 1. T·∫°o b·ªô b√†i 52 l√°
            const suits = ['‚ô†', '‚ô£', '‚ô¶', '‚ô•'];
            const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            let newDeck = [];
            for(let s of suits) {
                for(let v of values) {
                    let color = (s === '‚ô¶' || s === '‚ô•') ? 'red' : 'black';
                    newDeck.push({ suit: s, value: v, color: color });
                }
            }
            newDeck.sort(() => Math.random() - 0.5); // X√°o b√†i

            // 2. Chia cho m·ªói ng∆∞·ªùi 2 l√°
            // L·∫•y danh s√°ch players
            db.ref(`blackjack/${roomId}/players`).once('value', snap => {
                const players = snap.val() || {};
                const updates = {};
                
                // Chia cho nh√† con
                Object.keys(players).forEach(key => {
                    const c1 = newDeck.pop();
                    const c2 = newDeck.pop();
                    updates[`players/${key}/hand`] = [c1, c2];
                    updates[`players/${key}/status`] = 'playing';
                });

                // Chia cho nh√† c√°i
                const d1 = newDeck.pop();
                const d2 = newDeck.pop();
                updates[`dealer`] = { hand: [d1, d2] };
                
                updates[`deck`] = newDeck;
                updates[`status`] = 'playing';
                updates[`message`] = 'B·∫Øt ƒë·∫ßu! Nh√† con r√∫t b√†i ƒëi.';

                db.ref(`blackjack/${roomId}`).update(updates);
            });
        }

        // --- H√ÄNH ƒê·ªòNG C·ª¶A NH√Ä CON ---
        function hit() {
            // R√∫t 1 l√° t·ª´ b·ªô b√†i chung
            db.ref(`blackjack/${roomId}/deck`).transaction(currentDeck => {
                if(!currentDeck || currentDeck.length === 0) return currentDeck; // H·∫øt b√†i
                const card = currentDeck.pop(); // L·∫•y l√° cu·ªëi
                
                // C·∫≠p nh·∫≠t b√†i c·ªßa m√¨nh
                db.ref(`blackjack/${roomId}/players/${myName}/hand`).once('value', snap => {
                    const hand = snap.val() || [];
                    hand.push(card);
                    db.ref(`blackjack/${roomId}/players/${myName}/hand`).set(hand);
                });

                return currentDeck; // L∆∞u b·ªô b√†i c√≤n l·∫°i
            });
        }

        function stand() {
            db.ref(`blackjack/${roomId}/players/${myName}/status`).set('stand');
        }

        // --- H√ÄNH ƒê·ªòNG C·ª¶A NH√Ä C√ÅI ---
        function dealerHit() {
             db.ref(`blackjack/${roomId}/deck`).transaction(currentDeck => {
                if(!currentDeck || currentDeck.length === 0) return currentDeck;
                const card = currentDeck.pop();
                
                db.ref(`blackjack/${roomId}/dealer/hand`).once('value', snap => {
                    const hand = snap.val() || [];
                    hand.push(card);
                    db.ref(`blackjack/${roomId}/dealer/hand`).set(hand);
                });
                return currentDeck;
            });
        }

        function revealAll() {
            db.ref(`blackjack/${roomId}`).update({
                status: 'revealing',
                message: 'K·∫øt th√∫c! So ƒëi·ªÉm n√†o.'
            });
        }

        // --- H√ÄM H·ªñ TR·ª¢ (UI & T√çNH ƒêI·ªÇM) ---
        function renderHand(elementId, hand, showFace, isDealer) {
            const el = document.getElementById(elementId);
            el.innerHTML = '';
            if(!hand) return;

            hand.forEach((c, index) => {
                // N·∫øu kh√¥ng ƒë∆∞·ª£c xem m·∫∑t (showFace=false) th√¨ hi·ªán √∫p
                // Tr·ª´ khi l√† l√° ƒë·∫ßu ti√™n c·ªßa Nh√† c√°i (th∆∞·ªùng m·ªü 1 l√°) - ·ªû ƒë√¢y ta cho √∫p h·∫øt cho k·ªãch t√≠nh
                if (!showFace) {
                    el.innerHTML += `<div class="card card-back"></div>`;
                } else {
                    el.innerHTML += `
                        <div class="card ${c.color}">
                            <div style="font-size:0.8rem;position:absolute;top:2px;left:5px">${c.value}</div>
                            <div>${c.suit}</div>
                        </div>`;
                }
            });
        }

        function getScoreText(hand) {
            if(!hand) return 0;
            let score = 0;
            let aces = 0;
            
            // T√≠nh ƒëi·ªÉm s∆° b·ªô
            hand.forEach(c => {
                if(['J','Q','K'].includes(c.value)) score += 10;
                else if(c.value === 'A') { aces += 1; score += 1; } // M·∫∑c ƒë·ªãnh A l√† 1
                else score += parseInt(c.value);
            });

            // X·ª≠ l√Ω b√†i ƒë·∫∑c bi·ªát (ch·ªâ khi 2 l√°)
            if(hand.length === 2) {
                if(aces === 2) return "X√¨ B√†ng (Th·∫Øng)"; // AA
                if(aces === 1 && score >= 11) return "X√¨ D√°ch (Th·∫Øng)"; // A + 10/J/Q/K
            }
            
            // X·ª≠ l√Ω Ng≈© Linh (5 l√° <= 21)
            if(hand.length === 5 && score <= 21) {
                // Check l·∫°i logic A cho Ng≈© Linh n·∫øu c·∫ßn, nh∆∞ng c∆° b·∫£n <=21 l√† ƒÉn
                return `Ng≈© Linh (${score})`; 
            }

            // X·ª≠ l√Ω A t√≠nh l√† 10 ho·∫∑c 11
            // N·∫øu c√≥ A v√† c·ªông th√™m 10 m√† ch∆∞a Qu·∫Øc th√¨ c·ªông
            if (aces > 0 && score + 10 <= 21) {
                score += 10;
            }

            if (score > 21) return `Qu·∫Øc (${score})`;
            if (score < 16) return `Non (${score})`;
            return `ƒê·ªß tu·ªïi (${score})`;
        }
    </script>
</body>
</html>